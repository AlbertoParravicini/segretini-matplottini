# Automatic release on PyPI on merge to master
name: Publish segretini-matplottini to PyPI ðŸ“¦

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  pypi-publish:

    name: Publish segretini-matplottini to PyPI ðŸ“¦
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    strategy:
      matrix:
        python-version: ["3.9"]
    environment:
      name: pypi
      url: https://pypi.org/project/segretini-matplottini/
    permissions:
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install ".[dev]" --upgrade pip
    - name: Build package
      run: python -m build
    - name: Publish distribution to PyPI ðŸ“¦
      uses: pypa/gh-action-pypi-publish@release/v1
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # Get the version from pyproject.toml
        tag_name: v$(grep -E '^version = ".*"$' pyproject.toml | cut -d'"' -f2)
        release_name: v$(grep -E '^version = ".*"$' pyproject.toml | cut -d'"' -f2)
        body: |
          Automated release with tag ${{ steps.create_release.outputs.tag_name }}.
        draft: false
        prerelease: false

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -am "Bump version to v${{ steps.create_release.outputs.tag_name }}"
        git push
